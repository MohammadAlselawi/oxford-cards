<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oxford Master | Dark Mode</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Themes) --- */
        :root {
            /* Light Mode (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) */
            --primary: #6c5ce7;
            --primary-hover: #5649c0;
            --bg: #f1f2f6;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-secondary: #636e72;
            --border: #dfe6e9;
            --shadow: rgba(0,0,0,0.05);
            --modal-bg: rgba(255,255,255,0.98);
        }

        /* Dark Mode (Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„) */
        body.dark-mode {
            --primary: #8e7bf9; /* Ø¨Ù†ÙØ³Ø¬ÙŠ Ø£ÙØªØ­ Ù„Ù„ØªØ¨Ø§ÙŠÙ† */
            --primary-hover: #a29bfe;
            --bg: #18191a;      /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ù„ÙÙŠØ© */
            --card-bg: #242526; /* Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„ÙƒØ±ÙˆØª */
            --text: #e4e6eb;    /* Ø£Ø¨ÙŠØ¶ Ù‡Ø§Ø¯Ø¦ Ù„Ù„Ù†ØµÙˆØµ */
            --text-secondary: #b0b3b8;
            --border: #3a3b3c;
            --shadow: rgba(0,0,0,0.3);
            --modal-bg: rgba(24, 25, 26, 0.95);
        }

        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); min-height: 100vh; transition: background-color 0.3s, color 0.3s; }
        
        /* Header */
        header { background: var(--card-bg); padding: 1rem 2rem; box-shadow: 0 4px 20px var(--shadow); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; transition: 0.3s; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* Ø²Ø± Ø§Ù„Ø«ÙŠÙ… */
        .theme-btn { background: transparent; border: 2px solid var(--border); color: var(--text); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .theme-btn:hover { background: var(--border); }

        /* Controls Area */
        .controls-area { background: var(--card-bg); padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 1200px; box-shadow: 0 4px 15px var(--shadow); display: flex; flex-direction: column; gap: 15px; width: 90%; transition: 0.3s; }
        
        /* Sets Bar */
        .sets-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; scrollbar-width: thin; border-bottom: 2px solid var(--border); padding-bottom: 20px; }
        .set-btn { background: var(--card-bg); border: 2px solid var(--border); padding: 8px 16px; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: bold; color: var(--text-secondary); transition: 0.2s; }
        .set-btn:hover { border-color: var(--primary); color: var(--primary); }
        .set-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        /* Buttons & Inputs */
        select, .btn { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); outline: none; font-family: inherit; background: var(--card-bg); color: var(--text); }
        .btn { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--bg); }

        /* Grid */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; padding: 0 20px 40px; max-width: 1240px; margin: 0 auto; }
        .word-item { background: var(--card-bg); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: 0 2px 5px var(--shadow); }
        .word-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--shadow); border-color: var(--border); }
        .word-item.selected { border-color: var(--primary); background-color: rgba(108, 92, 231, 0.1); }
        .word-text { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1rem; color: var(--text); }
        input[type="checkbox"] { transform: scale(1.3); accent-color: var(--primary); cursor: pointer; }

        /* Flashcard Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .flashcard-container { perspective: 1000px; width: 90%; max-width: 500px; height: 320px; cursor: pointer; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; box-shadow: 0 15px 35px var(--shadow); border: 1px solid var(--border); }
        .flashcard.flipped { transform: rotateY(180deg); }
        
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; text-align: center; }
        
        /* Flashcard Colors */
        .card-front { background: var(--card-bg); color: var(--primary); }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); }
        
        /* Navigation Controls */
        .nav-controls { display: flex; gap: 15px; }
        .icon-btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .icon-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        #selection-counter { font-weight: bold; color: var(--primary); background: rgba(108, 92, 231, 0.1); padding: 5px 15px; border-radius: 20px; }
    </style>
</head>
<body>

    <header>
        <h1><span>ğŸ“</span> Oxford Master</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div id="selection-counter">0 Ù…Ø®ØªØ§Ø±Ø©</div>
            <button class="theme-btn" onclick="toggleTheme()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
        </div>
    </header>

    <div id="loading-msg" style="text-align: center; margin-top: 50px; color: var(--text);">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª...</div>

    <div id="main-interface" class="hidden">
        
        <div class="controls-area">
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold; color: var(--text);">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                <select id="cefr-filter" onchange="generateSets()" style="flex-grow: 1; max-width: 200px;">
                    </select>
            </div>

            <div class="sets-container" id="sets-bar">
                </div>

            <div style="display: flex; gap: 10px; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 15px;">
                <button class="btn btn-outline" onclick="selectAllInSet()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø©</button>
                <button class="btn" onclick="startFlashcards()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­ÙØ¸ ğŸš€</button>
            </div>
        </div>

        <h3 id="set-title" style="max-width: 1200px; margin: 0 auto 15px; padding: 0 20px; color: var(--text-secondary);">Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</h3>
        <div id="word-grid" class="grid-container"></div>
    </div>

    <div id="flashcard-modal" class="modal-overlay hidden">
        <div style="margin-bottom: 20px; color: var(--text-secondary);">Ø¨Ø·Ø§Ù‚Ø© <span id="current-index">1</span> Ù…Ù† <span id="total-count">10</span></div>
        
        <div class="flashcard-container" onclick="flipCard()">
            <div class="flashcard" id="card-element">
                <div class="card-face card-front">
                    <h2 style="font-family: 'Poppins'; font-size: 2.5rem; margin: 0;" id="fc-word">Word</h2>
                    <span id="fc-pos" style="background:var(--bg); padding:4px 12px; border-radius:10px; margin-top:10px; font-size:0.9rem; color:var(--text-secondary);">noun</span>
                </div>
                <div class="card-face card-back">
                    <p style="font-size: 1.6rem; line-height: 1.5;" id="fc-def">Definition</p>
                    <small id="fc-level" style="opacity: 0.8;">A1</small>
                </div>
            </div>
        </div>

        <div class="nav-controls">
            <button class="icon-btn" onclick="prevCard()">â¬…ï¸</button>
            <button class="icon-btn" onclick="speakWord()">ğŸ”Š</button>
            <button class="icon-btn" onclick="nextCard()">â¡ï¸</button>
        </div>
        <button onclick="closeFlashcards()" style="margin-top: 30px; background: none; border: none; color: var(--text-secondary); cursor: pointer; text-decoration: underline;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>

<script>
    let allData = [], currentLevelData = [], currentSetData = [];
    let selectedIndices = new Set(), practiceQueue = [];
    let currentCardIndex = 0;
    const SET_SIZE = 20;

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const btn = document.querySelector('.theme-btn');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            btn.innerText = 'â˜€ï¸';
        } else {
            btn.innerText = 'ğŸŒ™';
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.querySelector('.theme-btn').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
    window.onload = async function() {
        initTheme(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        try {
            const response = await fetch('./data.xlsx');
            if (!response.ok) throw new Error("File not found");
            const buffer = await response.arrayBuffer();
            const wb = XLSX.read(buffer, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            processData(rows);
        } catch (error) {
            document.getElementById('loading-msg').innerHTML = `<p style="color:#e74c3c">âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù data.xlsx</p>`;
        }
    };

    function processData(rows) {
        allData = rows.slice(1).map((row, i) => {
            if (!row[0]) return null;
            let raw = row[0].toString();
            return {
                id: i,
                word: raw.replace(/\(.*\)/, '').trim(),
                pos: raw.match(/\((.*?)\)/)?.[1] || '',
                cefr: row[1] || 'Uncategorized',
                def: row[3] || '...'
            };
        }).filter(x => x);

        const levels = [...new Set(allData.map(d => d.cefr))].sort();
        const select = document.getElementById('cefr-filter');
        levels.forEach(lvl => {
            const opt = document.createElement('option');
            opt.value = lvl; opt.innerText = `Level ${lvl}`;
            select.appendChild(opt);
        });

        document.getElementById('loading-msg').classList.add('hidden');
        document.getElementById('main-interface').classList.remove('hidden');
        generateSets();
    }

    function generateSets() {
        const level = document.getElementById('cefr-filter').value;
        currentLevelData = allData.filter(d => d.cefr === level);
        const setsCount = Math.ceil(currentLevelData.length / SET_SIZE);
        const setsBar = document.getElementById('sets-bar');
        setsBar.innerHTML = '';

        if (currentLevelData.length === 0) {
            setsBar.innerHTML = '<span style="color:var(--text-secondary)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>';
            renderGrid([]);
            return;
        }

        for (let i = 0; i < setsCount; i++) {
            const btn = document.createElement('div');
            btn.className = 'set-btn';
            btn.innerText = `Ù…Ø¬Ù…ÙˆØ¹Ø© ${i + 1}`;
            btn.onclick = () => loadSet(i, btn);
            setsBar.appendChild(btn);
        }
        if (setsBar.firstChild) setsBar.firstChild.click();
    }

    function loadSet(setIndex, btnElement) {
        document.querySelectorAll('.set-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        const start = setIndex * SET_SIZE;
        const end = start + SET_SIZE;
        currentSetData = currentLevelData.slice(start, end);
        document.getElementById('set-title').innerHTML = `Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† <b>${start + 1}</b> Ø¥Ù„Ù‰ <b>${Math.min(end, currentLevelData.length)}</b> (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${document.getElementById('cefr-filter').value})`;
        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('word-grid');
        grid.innerHTML = '';
        if(currentSetData.length === 0) {
            grid.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>';
            return;
        }
        currentSetData.forEach(item => {
            const isSelected = selectedIndices.has(item.id);
            const div = document.createElement('div');
            div.className = `word-item ${isSelected ? 'selected' : ''}`;
            div.onclick = (e) => { if(e.target.type !== 'checkbox') toggleSelection(item.id); };
            div.innerHTML = `<div><div class="word-text">${item.word}</div><span style="font-size:0.8rem; color:var(--text-secondary);">${item.pos}</span></div><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection(${item.id})">`;
            grid.appendChild(div);
        });
    }

    function toggleSelection(id) {
        if (selectedIndices.has(id)) selectedIndices.delete(id); else selectedIndices.add(id);
        updateCounter(); renderGrid();
    }

    function selectAllInSet() {
        const allSelected = currentSetData.every(d => selectedIndices.has(d.id));
        currentSetData.forEach(d => { allSelected ? selectedIndices.delete(d.id) : selectedIndices.add(d.id); });
        updateCounter(); renderGrid();
    }

    function updateCounter() { document.getElementById('selection-counter').innerText = `${selectedIndices.size} Ù…Ø®ØªØ§Ø±Ø©`; }

    function startFlashcards() {
        if (selectedIndices.size === 0) { alert("Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; }
        practiceQueue = allData.filter(d => selectedIndices.has(d.id)).sort(() => Math.random() - 0.5);
        currentCardIndex = 0; showCard(0);
        document.getElementById('flashcard-modal').classList.remove('hidden');
    }

    function showCard(idx) {
        const card = practiceQueue[idx];
        const el = document.getElementById('card-element');
        el.classList.remove('flipped');
        setTimeout(() => {
            document.getElementById('fc-word').innerText = card.word;
            document.getElementById('fc-pos').innerText = card.pos;
            document.getElementById('fc-def').innerText = card.def;
            document.getElementById('fc-level').innerText = card.cefr;
            document.getElementById('current-index').innerText = idx + 1;
            document.getElementById('total-count').innerText = practiceQueue.length;
        }, 200);
    }

    function flipCard() { document.getElementById('card-element').classList.toggle('flipped'); }
    function nextCard() { if (currentCardIndex < practiceQueue.length-1) showCard(++currentCardIndex); else { alert("ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!"); closeFlashcards(); }}
    function prevCard() { if (currentCardIndex > 0) showCard(--currentCardIndex); }
    function closeFlashcards() { document.getElementById('flashcard-modal').classList.add('hidden'); }
    function speakWord() { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(practiceQueue[currentCardIndex].word); u.lang = 'en-GB'; window.speechSynthesis.speak(u); }
</script>
</body>
</html>
