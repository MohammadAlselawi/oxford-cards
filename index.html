<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oxford 3000 Sets</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --bg: #f1f2f6; --card-bg: #ffffff; --text: #2d3436; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); min-height: 100vh; }
        
        /* Header */
        header { background: white; padding: 1rem 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* Controls Area */
        .controls-area { background: white; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 1200px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 15px; width: 90%; }
        
        /* Sets Bar */
        .sets-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; scrollbar-width: thin; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; }
        .set-btn { background: white; border: 2px solid #dfe6e9; padding: 8px 16px; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: bold; color: #636e72; transition: 0.2s; }
        .set-btn:hover { border-color: var(--primary); color: var(--primary); }
        .set-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        /* Buttons & Inputs */
        select, .btn { padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd; outline: none; font-family: inherit; }
        .btn { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: #f0f3ff; }

        /* Grid */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; padding: 0 20px 40px; max-width: 1240px; margin: 0 auto; }
        .word-item { background: var(--card-bg); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .word-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .word-item.selected { border-color: var(--primary); background-color: #f8f9fe; }
        .word-text { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1rem; color: #2d3436; }
        input[type="checkbox"] { transform: scale(1.3); accent-color: var(--primary); cursor: pointer; }

        /* Flashcard Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .flashcard-container { perspective: 1000px; width: 90%; max-width: 500px; height: 320px; cursor: pointer; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; text-align: center; }
        .card-front { background: white; color: var(--primary); }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); }
        
        .nav-controls { display: flex; gap: 15px; }
        .icon-btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid #ddd; background: white; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .icon-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 40px; color: #b2bec3; }
    </style>
</head>
<body>

    <header>
        <h1><span>ğŸ“</span> Oxford Master</h1>
        <div id="selection-counter" style="font-weight: bold; color: var(--primary); background: #f0f3ff; padding: 5px 15px; border-radius: 20px;">0 Ù…Ø®ØªØ§Ø±Ø©</div>
    </header>

    <div id="loading-msg" style="text-align: center; margin-top: 50px;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª...</div>

    <div id="main-interface" class="hidden">
        
        <div class="controls-area">
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                <select id="cefr-filter" onchange="generateSets()" style="flex-grow: 1; max-width: 200px;">
                    </select>
            </div>

            <div class="sets-container" id="sets-bar">
                </div>

            <div style="display: flex; gap: 10px; justify-content: space-between; border-top: 1px solid #eee; padding-top: 15px;">
                <button class="btn btn-outline" onclick="selectAllInSet()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø©</button>
                <button class="btn" onclick="startFlashcards()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­ÙØ¸ ğŸš€</button>
            </div>
        </div>

        <h3 id="set-title" style="max-width: 1200px; margin: 0 auto 15px; padding: 0 20px; color: #636e72;">Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</h3>
        <div id="word-grid" class="grid-container"></div>
    </div>

    <div id="flashcard-modal" class="modal-overlay hidden">
        <div style="margin-bottom: 20px; color: #888;">Ø¨Ø·Ø§Ù‚Ø© <span id="current-index">1</span> Ù…Ù† <span id="total-count">10</span></div>
        
        <div class="flashcard-container" onclick="flipCard()">
            <div class="flashcard" id="card-element">
                <div class="card-face card-front">
                    <h2 style="font-family: 'Poppins'; font-size: 2.5rem; margin: 0;" id="fc-word">Word</h2>
                    <span id="fc-pos" style="background:#f1f2f6; padding:4px 12px; border-radius:10px; margin-top:10px; font-size:0.9rem; color:#636e72;">noun</span>
                </div>
                <div class="card-face card-back">
                    <p style="font-size: 1.6rem; line-height: 1.5;" id="fc-def">Definition</p>
                    <small id="fc-level" style="opacity: 0.8;">A1</small>
                </div>
            </div>
        </div>

        <div class="nav-controls">
            <button class="icon-btn" onclick="prevCard()">â¬…ï¸</button>
            <button class="icon-btn" onclick="speakWord()">ğŸ”Š</button>
            <button class="icon-btn" onclick="nextCard()">â¡ï¸</button>
        </div>
        <button onclick="closeFlashcards()" style="margin-top: 30px; background: none; border: none; color: #888; cursor: pointer; text-decoration: underline;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>

<script>
    let allData = [];
    let currentLevelData = []; // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø·
    let currentSetData = [];   // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø§Ù„Ù€ 20 ÙƒÙ„Ù…Ø©)
    let selectedIndices = new Set();
    let practiceQueue = [];
    let currentCardIndex = 0;
    
    // Ø­Ø¬Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©)
    const SET_SIZE = 20;

    window.onload = async function() {
        try {
            const response = await fetch('./data.xlsx');
            if (!response.ok) throw new Error("Ù…Ù„Ù data.xlsx ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            const buffer = await response.arrayBuffer();
            const wb = XLSX.read(buffer, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            
            processData(rows);
        } catch (error) {
            document.getElementById('loading-msg').innerHTML = `<p style="color:red">âŒ Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù data.xlsx</p>`;
        }
    };

    function processData(rows) {
        // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        allData = rows.slice(1).map((row, i) => {
            if (!row[0]) return null;
            let raw = row[0].toString();
            return {
                id: i,
                word: raw.replace(/\(.*\)/, '').trim(),
                pos: raw.match(/\((.*?)\)/)?.[1] || '',
                cefr: row[1] || 'Uncategorized', // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ
                def: row[3] || '...'
            };
        }).filter(x => x);

        // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        const levels = [...new Set(allData.map(d => d.cefr))].sort();
        const select = document.getElementById('cefr-filter');
        levels.forEach(lvl => {
            const opt = document.createElement('option');
            opt.value = lvl; opt.innerText = `Level ${lvl}`;
            select.appendChild(opt);
        });

        document.getElementById('loading-msg').classList.add('hidden');
        document.getElementById('main-interface').classList.remove('hidden');
        
        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø³ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        generateSets();
    }

    // 1. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    function generateSets() {
        const level = document.getElementById('cefr-filter').value;
        currentLevelData = allData.filter(d => d.cefr === level);
        
        const setsCount = Math.ceil(currentLevelData.length / SET_SIZE);
        const setsBar = document.getElementById('sets-bar');
        setsBar.innerHTML = '';

        if (currentLevelData.length === 0) {
            setsBar.innerHTML = '<span style="color:#aaa">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>';
            renderGrid([]);
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©
        for (let i = 0; i < setsCount; i++) {
            const btn = document.createElement('div');
            btn.className = 'set-btn';
            btn.innerText = `Ù…Ø¬Ù…ÙˆØ¹Ø© ${i + 1}`;
            btn.onclick = () => loadSet(i, btn);
            setsBar.appendChild(btn);
        }

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        if (setsBar.firstChild) setsBar.firstChild.click();
    }

    // 2. Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    function loadSet(setIndex, btnElement) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.set-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
        const start = setIndex * SET_SIZE;
        const end = start + SET_SIZE;
        
        currentSetData = currentLevelData.slice(start, end);
        
        const title = document.getElementById('set-title');
        title.innerHTML = `Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ù† <b>${start + 1}</b> Ø¥Ù„Ù‰ <b>${Math.min(end, currentLevelData.length)}</b> (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${document.getElementById('cefr-filter').value})`;

        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('word-grid');
        grid.innerHTML = '';

        if(currentSetData.length === 0) {
            grid.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>';
            return;
        }

        currentSetData.forEach(item => {
            const isSelected = selectedIndices.has(item.id);
            const div = document.createElement('div');
            div.className = `word-item ${isSelected ? 'selected' : ''}`;
            div.onclick = (e) => { 
                if(e.target.type !== 'checkbox') toggleSelection(item.id); 
            };
            
            div.innerHTML = `
                <div>
                    <div class="word-text">${item.word}</div>
                    <span style="font-size:0.8rem; color:#b2bec3;">${item.pos}</span>
                </div>
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection(${item.id})">
            `;
            grid.appendChild(div);
        });
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    function toggleSelection(id) {
        if (selectedIndices.has(id)) selectedIndices.delete(id);
        else selectedIndices.add(id);
        
        updateCounter();
        renderGrid(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    }

    function selectAllInSet() {
        const allSelected = currentSetData.every(d => selectedIndices.has(d.id));
        
        currentSetData.forEach(d => {
            if (allSelected) selectedIndices.delete(d.id); // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            else selectedIndices.add(d.id); // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
        });
        
        updateCounter();
        renderGrid();
    }

    function updateCounter() {
        document.getElementById('selection-counter').innerText = `${selectedIndices.size} ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø­ÙØ¸`;
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯Ø² (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨ØµØ±ÙŠØ©)
    function startFlashcards() {
        if (selectedIndices.size === 0) { alert("Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; }
        
        // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø·
        practiceQueue = allData.filter(d => selectedIndices.has(d.id));
        // Ø®Ù„Ø· Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        practiceQueue.sort(() => Math.random() - 0.5);
        
        currentCardIndex = 0;
        showCard(0);
        document.getElementById('flashcard-modal').classList.remove('hidden');
    }

    function showCard(idx) {
        const card = practiceQueue[idx];
        const el = document.getElementById('card-element');
        el.classList.remove('flipped'); // Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø£ÙˆÙ„
        
        setTimeout(() => {
            document.getElementById('fc-word').innerText = card.word;
            document.getElementById('fc-pos').innerText = card.pos;
            document.getElementById('fc-def').innerText = card.def;
            document.getElementById('fc-level').innerText = card.cefr;
            document.getElementById('current-index').innerText = idx + 1;
            document.getElementById('total-count').innerText = practiceQueue.length;
        }, 200);
    }

    function flipCard() { document.getElementById('card-element').classList.toggle('flipped'); }
    function nextCard() { if (currentCardIndex < practiceQueue.length-1) showCard(++currentCardIndex); else { alert("ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!"); closeFlashcards(); }}
    function prevCard() { if (currentCardIndex > 0) showCard(--currentCardIndex); }
    function closeFlashcards() { document.getElementById('flashcard-modal').classList.add('hidden'); }
    function speakWord() { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(practiceQueue[currentCardIndex].word); u.lang = 'en-GB'; window.speechSynthesis.speak(u); }

</script>
</body>
</html>
